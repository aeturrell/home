<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arthur Turrell">
<meta name="dcterms.date" content="2023-09-28">
<meta name="description" content="Arthur Turrell is an economic data scientist.">

<title>Building an API in the cloud in fewer than 200 lines of code | Arthur Turrell</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../..//files/logo_large.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-46P0B31B3F"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-46P0B31B3F', { 'anonymize_ip': true});
</script>


<meta property="og:title" content="Building an API in the cloud in fewer than 200 lines of code | Arthur Turrell">
<meta property="og:description" content="Arthur Turrell is an economic data scientist.">
<meta property="og:image" content="https://www.aeturrell.com//files/logo_large.png">
<meta property="og:site-name" content="Arthur Turrell">
<meta property="og:locale" content="en_UK">
<meta property="og:image:height" content="1594">
<meta property="og:image:width" content="1594">
<meta name="twitter:title" content="Building an API in the cloud in fewer than 200 lines of code | Arthur Turrell">
<meta name="twitter:description" content="Arthur Turrell is an economic data scientist.">
<meta name="twitter:image" content="https://www.aeturrell.com//files/logo_large.png">
<meta name="twitter:creator" content="@arthurturrell">
<meta name="twitter:site" content="@arthurturrell">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1594">
<meta name="twitter:image-width" content="1594">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Arthur Turrell</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../research/index.html" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../media/index.html" rel="" target="">
 <span class="menu-text">Media</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../thestarbuilders/thestarbuilders.html" rel="" target="">
 <span class="menu-text">The Star Builders</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../teaching/index.html" rel="" target="">
 <span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../code/index.html" rel="" target="">
 <span class="menu-text">Code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../uses/index.html" rel="" target="">
 <span class="menu-text">Setup</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../../atom.xml" rel="" target=""><i class="bi bi-rss" role="img" aria-label="rss">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../contact.html" rel="" target=""><i class="bi bi-envelope" role="img" aria-label="contact">
</i> 
 <span class="menu-text"> </span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/arthurturrell" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/aeturrell" rel="" target=""><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/arthur-turrell-8b789891" rel="" target=""><i class="bi bi-linkedin" role="img" aria-label="linkedin">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Building an API in the cloud in fewer than 200 lines of code</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">open-source</div>
                <div class="quarto-category">cloud</div>
                <div class="quarto-category">data science</div>
                <div class="quarto-category">python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Arthur Turrell </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 28, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#google-cloud-platform" id="toc-google-cloud-platform" class="nav-link" data-scroll-target="#google-cloud-platform">Google Cloud Platform</a></li>
  <li><a href="#terraform" id="toc-terraform" class="nav-link" data-scroll-target="#terraform">Terraform</a></li>
  <li><a href="#python-and-fastapi" id="toc-python-and-fastapi" class="nav-link" data-scroll-target="#python-and-fastapi">Python and FastAPI</a></li>
  </ul></li>
  <li><a href="#initial-setup" id="toc-initial-setup" class="nav-link" data-scroll-target="#initial-setup">Initial Setup</a>
  <ul class="collapse">
  <li><a href="#code-installs" id="toc-code-installs" class="nav-link" data-scroll-target="#code-installs">Code Installs</a></li>
  <li><a href="#create-a-google-project" id="toc-create-a-google-project" class="nav-link" data-scroll-target="#create-a-google-project">Create a Google Project</a></li>
  <li><a href="#terraforming-google-cloud-components" id="toc-terraforming-google-cloud-components" class="nav-link" data-scroll-target="#terraforming-google-cloud-components">Terraforming Google Cloud Components</a></li>
  </ul></li>
  <li><a href="#python-and-the-api" id="toc-python-and-the-api" class="nav-link" data-scroll-target="#python-and-the-api">Python and the API</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#prepping-the-data" id="toc-prepping-the-data" class="nav-link" data-scroll-target="#prepping-the-data">Prepping the data</a></li>
  <li><a href="#launching-the-api-locally-optional" id="toc-launching-the-api-locally-optional" class="nav-link" data-scroll-target="#launching-the-api-locally-optional">Launching the API locally (optional)</a></li>
  </ul></li>
  <li><a href="#deploying-the-api-to-the-cloud" id="toc-deploying-the-api-to-the-cloud" class="nav-link" data-scroll-target="#deploying-the-api-to-the-cloud">Deploying the API to the cloud</a>
  <ul class="collapse">
  <li><a href="#building-the-docker-image" id="toc-building-the-docker-image" class="nav-link" data-scroll-target="#building-the-docker-image">Building the docker image</a></li>
  <li><a href="#testing-the-containerised-api-locally-optional" id="toc-testing-the-containerised-api-locally-optional" class="nav-link" data-scroll-target="#testing-the-containerised-api-locally-optional">Testing the containerised API locally (optional)</a></li>
  <li><a href="#building-the-docker-image-for-google-cloud-run" id="toc-building-the-docker-image-for-google-cloud-run" class="nav-link" data-scroll-target="#building-the-docker-image-for-google-cloud-run">Building the docker image for Google Cloud Run</a></li>
  <li><a href="#deploy" id="toc-deploy" class="nav-link" data-scroll-target="#deploy">Deploy</a></li>
  </ul></li>
  <li><a href="#heres-one-i-built-earlier" id="toc-heres-one-i-built-earlier" class="nav-link" data-scroll-target="#heres-one-i-built-earlier">Here’s one I built earlier!</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<p>Cloud tools and Python packages have become so powerful that you can build a (scalable) cloud-based API in fewer than 200 lines of code. In this blog post, you’ll see how to use Google Cloud, Terraform, and FastAPI to deploy a queryable data API on the cloud.</p>
<p>The repository associated with this project <a href="https://github.com/aeturrell/deploy-api">can be found here</a> should you wish to try this for yourself.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="run_using_data.png" class="img-fluid figure-img" style="width:30.0%" alt="Image showing JSON returned by API."></p>
<figcaption class="figure-caption margin-caption">An example of the API created in this blog post returning data.</figcaption>
</figure>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The basic idea here is: create an image of a computer that serves up an API, stick it on a scalable cloud function, and let it rip so that anyone can query it.</p>
<p>Why might you want to deploy an API? I <a href="../../../blog/posts/the-prize-with-apis/the-prize-with-apis.html">covered this in a previous blog post</a> and the short answer is that they’re awesome at servicing data or prediction requests in an efficient way.</p>
<p>First, some caveats. I’m only counting lines of code for the API and the cloud infrastructure, not for the extraction and transform of the data we’ll be serving up. ie, this doesn’t count the code that creates the data, which is in the <code>etl</code> folder. This seems fair: I happened to pick a dataset that needed a bit of “E” and “T” love before being usable, but I could have started with any old dataset. Second: if you’re going to follow this and create your own scalable cloud API, you will need a Google Cloud account with the billing setup (or some free credits). Finally, be very careful not to share your cloud keys or your real terraform variable names if you are following this tutorial on a public repo. I’ve added the relevant files to the <code>.gitignore</code> file for those cloning the repo but you should be as cautious as ever when dealing with secrets that should not be shared publicly.</p>
<p>Okay, let’s look at the technologies we’re going to use.</p>
<section id="google-cloud-platform" class="level3">
<h3 class="anchored" data-anchor-id="google-cloud-platform">Google Cloud Platform</h3>
<p>Google Cloud Platform (GCP) provides a whole suite of cloud services, and is one of the major providers. It seems to have been made for data scientists, and has a great command line interface. The specific GCP components we’ll be using are:</p>
<ul>
<li>an image registry, to store the image of a computer than can serve up data via an API</li>
<li>Google Cloud Run, which actually serves up the computer image</li>
</ul>
<p>It’s worth nothing that Cloud Run is serverless, which means you don’t have to fiddle with back-end resources to run applications. It can scale up or down as needed. Essentially, Google are handling the back-end stuff so you don’t have to. Like any tech, it has its limitations, but it’s a great choice for a simple, pain-free API deployment based on a container.</p>
</section>
<section id="terraform" class="level3">
<h3 class="anchored" data-anchor-id="terraform">Terraform</h3>
<p>As cloud platforms have proliferated, there’s a danger of getting back to point-and-click interfaces, problems with reproducibility, vendor lock-in, and other things we try to avoid as data scientists. Terraform is a tool that helps you do “infrastructure as code”, ie to build, change, and version control cloud resources safely and efficiently. One of the advantages is, once you have specified it once, you can re-use a Terraform plan to create the same infrastructure again down the line.</p>
</section>
<section id="python-and-fastapi" class="level3">
<h3 class="anchored" data-anchor-id="python-and-fastapi">Python and FastAPI</h3>
<p>FastAPI is a Python package for building APIs that has a whole range of benefits:</p>
<ul>
<li>Very high performance.</li>
<li>Fast to code with fewer bugs, as picks up type hints and makes use of decorators.</li>
<li>Full code completion support.</li>
<li>Automatically creates interactive documentation.</li>
<li>Based on (and fully compatible with) the open standards for APIs: OpenAPI (previously known as Swagger) and JSON Schema.</li>
</ul>
<p>Let’s see an example of some of this good stuff. First, the API endpoint is incredibly simple to create. Say we have a dataframe, <code>df</code>, which has the data we’d like to serve in. To turn a Python function that serves up data according to particular cuts into an API we need only add a decorator, an <code>async</code> statement, and add type hints. Here’s a simplified version of the example that gets built through the rest of this blog post:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/year/</span><span class="sc">{year}</span><span class="st">/geo_code/</span><span class="sc">{geo_code}</span><span class="st">"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> read_item(year: <span class="bu">int</span>, geo_code: <span class="bu">str</span>):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    json_data <span class="op">=</span> df.loc[</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">"year"</span>] <span class="op">==</span> year) <span class="op">&amp;</span> (df[<span class="st">"geo_code"</span>] <span class="op">==</span> geo_code), <span class="st">"deaths"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    ].to_dict()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"year"</span>: year, <span class="st">"geo_code"</span>: geo_code, <span class="st">"data"</span>: json_data}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This simple declaration buys us a lot. If you hit the API endpoint from this repo with this query: <code>/year/notanumber/geo_code/E08000007</code>, ie a valid geographic code but year is not an integer, then <strong><a href="https://docs.pydantic.dev/latest/">pydantic</a></strong> data validation checks are automatically run and return the following error message to the user:</p>
<pre class="text"><code>{
  "detail": [
    {
      "type": "int_parsing",
      "loc": [
        "path",
        "year"
      ],
      "msg": "Input should be a valid integer, unable to parse string as an integer",
      "input": "notanumber",
      "url": "https://errors.pydantic.dev/2.4/v/int_parsing"
    }
  ]
}</code></pre>
<p>The API knows you didn’t pass a valid integer! The <code>year: int</code> part of the function declaration determines that any input to the year segment of the API must be an integer.</p>
<p>Okay, with a bit of context out of the way, let’s now walkthrough building an API. All of <a href="https://github.com/aeturrell/deploy-api">the code is available here</a>.</p>
</section>
</section>
<section id="initial-setup" class="level2">
<h2 class="anchored" data-anchor-id="initial-setup">Initial Setup</h2>
<section id="code-installs" class="level3">
<h3 class="anchored" data-anchor-id="code-installs">Code Installs</h3>
<p>Download and install <a href="https://developer.hashicorp.com/terraform/downloads"><strong>terraform</strong></a>. Do the same for <a href="https://python-poetry.org/"><strong>poetry</strong></a> and ensure you have a Python installation (this tutorial uses Python 3.10 and that version is baked into the <code>pyproject.toml</code> file that <strong>poetry</strong> uses—<a href="https://github.com/aeturrell/deploy-api/blob/main/pyproject.toml">link here</a>).</p>
</section>
<section id="create-a-google-project" class="level3">
<h3 class="anchored" data-anchor-id="create-a-google-project">Create a Google Project</h3>
<p>Get a <a href="https://console.cloud.google.com/">Google Cloud Account</a>.</p>
<p>Ensure you have the <a href="https://cloud.google.com/sdk/docs/install-sdk">Google CLI installed</a> and authenticated: once you have downloaded and installed it, run <code>gcloud init</code> to set it up. Then run <code>gcloud auth login</code> to ensure you are logged into your account. With these steps done, you can make changes to your Google Cloud account from the command line.</p>
<p>We’re now going to create a project on the command line.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> projects create YOUR-PROJECT-ID</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You may wish to add some numbers to the end of the project name to ensure it is unique, as most obvious names are already taken (and, if a name is taken, project creation will fail). (Note that you will need to set the same project ID in your <code>terraform.tfvars</code> file, which we’ll come to later.)</p>
<p>Next up, switch the Google Cloud CLI to use this specific project:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> config set project YOUR-PROJECT-ID</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we have to go to the <a href="https://console.cloud.google.com/">Google Cloud Console</a>. Navigate to the relevant project, and then create a new Service Account under IAM. The current <a href="https://console.cloud.google.com/iam-admin/serviceaccounts">URL is here</a>. A service account can be used to manage access to Google Cloud services.</p>
<p>In the new service account, click on Actions then Manage keys. Create a new key and download it as a JSON file—do not put it under version control! If you’re following this tutorial by cloning the <a href="https://github.com/aeturrell/deploy-api">associated repo</a>, you can put it in the <code>secrets</code> subdirectory with the name <code>google_key.json</code> because the contents of the <code>secrets</code> folder are not under version control—but always, always double check.</p>
<p>If you haven’t already, you’ll also need to set up billing, which can be found under Billing in the left-hand side navigation pane. For me, the cost of setting this up was less than 1 pence.</p>
</section>
<section id="terraforming-google-cloud-components" class="level3">
<h3 class="anchored" data-anchor-id="terraforming-google-cloud-components">Terraforming Google Cloud Components</h3>
<p>Terraform is a cross-cloud way of specifying resources. We’re going to use it enable a couple of cloud APIs and name an Artifact Registry. (This registry is eventually where we will push a docker image of our app.)</p>
<p><code>main.tf</code> is the main terraform file (<a href="https://github.com/aeturrell/deploy-api/blob/main/main.tf">link here</a>). It lists the API services that we’ll use from Google, gives them names, and also enables them too. There are a few distinct blocks:</p>
<ol type="1">
<li>terraform metadata</li>
<li>provider region and project information</li>
<li>a block representing the container registry API</li>
<li>(last two blocks) code that enables the registry and cloud run APIs</li>
</ol>
<p>One of the slightly confusing things about terraform is that it works out what order to apply these changes in itself, so we don’t have to worry about the fact that the blocks enabling APIs come after the blocks creating new resources under specific APIs.</p>
<p><code>.terraform.version</code> contains the version of terraform you’re using (run <code>terraform --version</code> to check).</p>
<p><code>variables.tf</code> provides meta-data on the variables needed in your project (<a href="https://github.com/aeturrell/deploy-api/blob/main/variables.tf">link here</a>).</p>
<p>In an extra file, that is not included in this repo and which shouldn’t be public, called <code>terraform.tfvars</code>, put the actual names of your Google Cloud Project variables. The contents will look like this:</p>
<pre class="text"><code>#  GCP settings
project_id = "YOUR PROJECT ID"
region = "YOUR REGION"

#  Artifact registry
registry_id = "YOUR ARTIFACT REGISTRY NAME"</code></pre>
<p>There should be an entry in this file for every variable in the <code>variables.tf</code> file.</p>
<p>Now run <code>terraform init</code>. If successful, you should see a message saying “Terraform has been successfully initialized!”.</p>
<p>Next, run <code>terraform plan</code>, which will think through what you’ve asked for in <code>main.tf</code>.</p>
<p>Finally, to create the GCP resources, it’s <code>terraform apply</code>. If successful, you will see a message saying: “Apply complete! Resources: 3 added, 0 changed, 0 destroyed.”</p>
<p>An alternative to using the last block of <code>main.tf</code> to enable the APIs is to use the Google Cloud CLI.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> services enable artifactregistry.googleapis.com</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> services enable run.googleapis.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can check what services you have enabled with <code>gcloud services list --enabled</code>. If you’re doing a huge project and want to filter, you can of course <code>grep</code> your way to the info you’re interested in, eg <code>gcloud services list --enabled | grep run</code> to check whether <code>run.googleapis.com</code> is on the list.</p>
</section>
</section>
<section id="python-and-the-api" class="level2">
<h2 class="anchored" data-anchor-id="python-and-the-api">Python and the API</h2>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>Run <code>poetry config virtualenvs.in-project true</code> to make virtual environments be installed in the local project folder.</p>
<p>Run <code>poetry install</code> to install the Python env. If this has worked, you’ll see a <code>.venv</code> folder appear and, if you’re using it, Visual Studio Code might ask if you want to use the newly created environment for executing Python code. (Note that <code>poetry config virtualenvs.in-project true</code> doesn’t always play nicely with conda; there’s an <a href="https://github.com/python-poetry/poetry/issues/4055">open Poetry issue about this</a> but it <em>did</em> seem to work when in the <code>base</code> environment of conda.)</p>
<p>To try and help achieve high code quality, this repository uses <code>pre-commit</code>. You can run this using <code>poetry run pre-commit run --all-files</code>. As this is not essential, and the associated specification of packages isn’t really code, I didn’t include the file that specifies the pre-commit checks, <code>.pre-commit-config.yaml</code>, in the count of the number of lines of code.</p>
</section>
<section id="prepping-the-data" class="level3">
<h3 class="anchored" data-anchor-id="prepping-the-data">Prepping the data</h3>
<p>You can choose any small dataset you like here. In this case, because it’s more fun, I stitched together some data on deaths that was scattered across Excel files in a weird format for the API to serve up. You can <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/monthlyfiguresondeathsregisteredbyareaofusualresidence">find the original data files here</a>. For larger datasets, you’d want to do a “load” (the “L” in “ETL”) step too, and have the data live in a GCP database that gets queried by the API.</p>
<p>NB: the data are not included in the repo, you’ll need to run the Python scripts yourself!</p>
<p>There are a few Python scripts in a folder called <code>etl</code>. These perform the following functions:</p>
<ul>
<li><code>etl/extract.py</code> — downloads deaths data by geography from this ONS page, which has Excel files for each year. The script downloads them all. <a href="https://github.com/aeturrell/deploy-api/blob/main/etl/extract.py">Link</a>.</li>
<li><code>etl/transform.py</code> - this takes downloaded files, opens them, finds the relevant sheets, cleans them, and stacks them in a tidy format in a parquet file. <a href="https://github.com/aeturrell/deploy-api/blob/main/etl/transform.py">Link</a>. Challenges are:
<ul>
<li>Worksheet names change over time</li>
<li>File formats change (the file extension)</li>
<li>New data may be added in a new file, if the new data refer to January, or added into an existing file, if the month they refer to is not January</li>
</ul></li>
<li><code>etl/main.py</code> — this is a script that calls the extract and transform scripts in order to create the final dataset, <code>scratch/deaths_data.parquet</code>. <a href="https://github.com/aeturrell/deploy-api/blob/main/etl/main.py">Link</a>.</li>
</ul>
<p>To create the data we’ll be serving up later, it’s</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> run python etl/main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="launching-the-api-locally-optional" class="level3">
<h3 class="anchored" data-anchor-id="launching-the-api-locally-optional">Launching the API locally (optional)</h3>
<p>To use FastAPI locally to serve up your API and check it works, you’ll need to have installed the Python environment (via <strong>poetry</strong>)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> run uvicorn app.api:app <span class="at">--reload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where app is the folder, <code>api.py</code> is the script, and app is the FastAPI application defined in <code>api.py</code>. This serves up an API in the form: <code>/year/{YEAR-OF-INTEREST}/geo_code/{GEO-CODE-OF-INTEREST}</code>. For example, if FastAPI is running on <a href="http://0.0.0.0:8080">http://0.0.0.0:8080</a>, then <a href="http://0.0.0.0:8080/year/2021/geo_code/E08000007">http://0.0.0.0:8080/year/2021/geo_code/E08000007</a> would serve up the 2021 deaths data for Stockport (which has UK local authority geographic code E08000007). You can also try <a href="http://0.0.0.0:8080/docs">http://0.0.0.0:8080/docs</a> to see how you get automatic interactive docs for free with FastAPI!</p>
</section>
</section>
<section id="deploying-the-api-to-the-cloud" class="level2">
<h2 class="anchored" data-anchor-id="deploying-the-api-to-the-cloud">Deploying the API to the cloud</h2>
<p>We already enabled the Cloud Run API using terraform. The plan now is: build a docker container with everything needed to serve up the API in, build the docker file into an image, upload the image to the artifact registry we created on Google Cloud, and then serve the API on Google Cloud Run. First, we need to ensure our env is reproducible in a docker file.</p>
<section id="building-the-docker-image" class="level3">
<h3 class="anchored" data-anchor-id="building-the-docker-image">Building the docker image</h3>
<p>You can make <strong>poetry</strong> (which this project uses) work in docker files but it can go wrong, so it’s easier to run:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> export <span class="at">-f</span> requirements.txt <span class="at">--output</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And have the docker file use the <code>requirements.txt</code>. Note that, because of this method of prepping the docker file, <code>requirements.txt</code> has been added to the <code>.gitignore</code> file. This follows the single source of truth rule: if we keep <code>requirements.txt</code> and <code>pyproject.toml</code> under version control simultaneously, it creates confusion as to which defines the environment. In this approach, it’s clear: <code>pyproject.toml</code> sets out the Python dependencies and <code>requirements.txt</code> is downstream of that.</p>
<p>Note that the dockerfile is just 16 lines of code and only includes the absolute bare minimum required to run the API.</p>
<p>Also note that the name <code>deaths_data.parquet</code> is hard-coded in the dockerfile. There’s probably a way to get it to pull the name of the data file from the <code>config.toml</code> file where it’s defined, but let’s keep things simple.</p>
</section>
<section id="testing-the-containerised-api-locally-optional" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-containerised-api-locally-optional">Testing the containerised API locally (optional)</h3>
<p>You can check that your Dockerfile works locally first if you wish. To do this, run</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">--pull</span> <span class="at">--rm</span> <span class="at">-f</span> <span class="st">"Dockerfile"</span> <span class="at">-t</span> deploy-api:latest <span class="st">"."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to build it and then</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-it</span> <span class="at">-p</span> 8080:8080/tcp deploy-api:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to run it. You should get a message in the terminal that includes a HTTP address that you can go to (this isn’t really on the internet… it’s coming from inside the house!). Click on that and you should see your API load up. For example, if it’s on <a href="http://0.0.0.0:8080">http://0.0.0.0:8080</a> head to <a href="http://0.0.0.0:8080/docs">http://0.0.0.0:8080/docs</a> to check that the docs have loaded and try out the API.</p>
</section>
<section id="building-the-docker-image-for-google-cloud-run" class="level3">
<h3 class="anchored" data-anchor-id="building-the-docker-image-for-google-cloud-run">Building the docker image for Google Cloud Run</h3>
<p>Now we run into a complication. I’m using a Mac, which is on arm64 architecture, aka Apple Silicon. Most cloud services are Linux-based, which typically use amd64 chips. Naively building an image locally, and pushing it to Google Cloud, would result in an image that won’t actually run on Google’s architecture. So we need to use a multi-platform build, or just build to target a specific architecture. (Docker is supposed to solve this kind of problem, and it does, with a bit more effort.)</p>
<p>You need to use</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> buildx create <span class="at">--name</span> mybuilder <span class="at">--bootstrap</span> <span class="at">--use</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to create a builder to take on image construction. Then, the magic command to build the image and push it to your google repo is:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> buildx build <span class="at">--file</span> Dockerfile <span class="dt">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--platform</span> linux/amd64 <span class="dt">\</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--builder</span> mybuilder <span class="dt">\</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--progress</span> plain <span class="dt">\</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--build-arg</span> DOCKER_REPO=REGION-docker.pkg.dev/PROJECT-ID/REPOSITORY-NAME/ <span class="dt">\</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--pull</span> <span class="at">--push</span> <span class="dt">\</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--tag</span> REGION-docker.pkg.dev/PROJECT-ID/REPOSITORY-NAME/deploy-api:latest .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where REPOSITORY-NAME is the name of the <code>registry_id</code> variable in <code>terraform.tfvars</code>. Note the “platform” argument.</p>
</section>
<section id="deploy" class="level3">
<h3 class="anchored" data-anchor-id="deploy">Deploy</h3>
<p>Now deploy the app with</p>
<p><code>gcloud run deploy app --image REGION-docker.pkg.dev/PROJECT-ID/REPOSITORY-NAME/deploy-api:latest --region REGION --platform managed --allow-unauthenticated</code></p>
<p>All being well, you should get a message saying</p>
<pre class="text"><code>Deploying container to Cloud Run service [app] in project [PROJECT-ID] region [REGION]
✓ Deploying new service... Done.
  ✓ Creating Revision...
  ✓ Routing traffic...
  ✓ Setting IAM Policy...
Done.</code></pre>
</section>
</section>
<section id="heres-one-i-built-earlier" class="level2">
<h2 class="anchored" data-anchor-id="heres-one-i-built-earlier">Here’s one I built earlier!</h2>
<p>You can see a running version of the app from the repo here: <a href="https://app-qdvgjvqwza-nw.a.run.app">https://app-qdvgjvqwza-nw.a.run.app</a>. You can find <a href="https://app-qdvgjvqwza-nw.a.run.app/docs">the docs here</a>. And <a href="https://app-qdvgjvqwza-nw.a.run.app/year/2021/geo_code/E08000007">here’s an example that returns data</a>. Note that one constraint of Cloud Run is that it takes a moment to start if no-one has used the link for a while.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>It’s worth noting that, if all your API is doing is serving up tabular data, there is an easier way to to this (even though building an API with FastAPI is so easy). You can use the excellent <a href="https://datasette.io/">datasette</a>. You can see a worked example of using it to <a href="https://github.com/aeturrell/datasette_particulate_matter">serve up some data here</a>. It seems like FastAPI would be much more useful with more unusually structured data, when you need to interact with data by writing as well as reading, or when you need Cloud Run to do other activities too (like pull from a Google database).</p>
<p>The commoditisation of cloud services, and the great developments in Python as a language, have made it far, far easier to create high quality APIs. Although there are a few components to get your head around here, it’s amazing how quickly you can create a working API—and how few lines of code are required.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>